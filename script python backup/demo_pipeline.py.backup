#!/usr/bin/env python3
"""
DÃ©monstration Pipeline SuperWhisper V6 - Task 18.8
ğŸš¨ CONFIGURATION GPU: RTX 3090 (CUDA:1) OBLIGATOIRE

Script dÃ©monstration utilisant le code OBLIGATOIRE du prompt
"""

import os
import sys
import asyncio
import time
import signal
from pathlib import Path
from typing import Optional, Dict, Any
import logging

# =============================================================================
# ğŸš¨ CONFIGURATION CRITIQUE GPU - RTX 3090 UNIQUEMENT 
# =============================================================================
os.environ['CUDA_VISIBLE_DEVICES'] = '1'        # RTX 3090 24GB EXCLUSIVEMENT
os.environ['CUDA_DEVICE_ORDER'] = 'PCI_BUS_ID'  # Ordre stable des GPU
os.environ['PYTORCH_CUDA_ALLOC_CONF'] = 'max_split_size_mb:1024'

print("ğŸ® Demo Pipeline: RTX 3090 (CUDA:1) forcÃ©e")
print(f"ğŸ”’ CUDA_VISIBLE_DEVICES: {os.environ.get('CUDA_VISIBLE_DEVICES')}")

# Ajouter le rÃ©pertoire parent au path pour imports
sys.path.insert(0, str(Path(__file__).parent.parent.parent))

# =============================================================================
# IMPORTS ET CONFIGURATION
# =============================================================================

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s â€“ %(levelname)s â€“ %(name)s â€“ %(message)s",
)
LOGGER = logging.getLogger("DemoPipeline")

# =============================================================================
# FONCTION BOOTSTRAP OBLIGATOIRE DU PROMPT
# =============================================================================

async def _bootstrap(cfg_path: Optional[str] = None):
    """Bootstrap function from prompt - MANDATORY CODE"""
    import yaml
    cfg: Dict[str, Any] = {}
    if cfg_path and Path(cfg_path).exists():
        cfg = yaml.safe_load(Path(cfg_path).read_text())

    # Import components
    from STT.unified_stt_manager_optimized import OptimizedUnifiedSTTManager
    from TTS.tts_manager import UnifiedTTSManager
    from PIPELINE.pipeline_orchestrator import PipelineOrchestrator

    # âœ… CORRECTION: Use OptimizedUnifiedSTTManager
    stt = OptimizedUnifiedSTTManager(cfg.get("stt", {}))
    tts = UnifiedTTSManager(cfg.get("tts", {}))
    orchestrator = PipelineOrchestrator(
        stt,
        tts,
        llm_endpoint=cfg.get("pipeline", {}).get("llm_endpoint", "http://localhost:8000"),
        metrics_enabled=cfg.get("pipeline", {}).get("enable_metrics", False),
    )
    await orchestrator.start()

# =============================================================================
# DÃ‰MONSTRATION INTERACTIVE
# =============================================================================

class PipelineDemo:
    """DÃ©monstration interactive utilisant le code obligatoire du prompt"""
    
    def __init__(self):
        self.config_path = "PIPELINE/config/pipeline.yaml"
        
    async def run_demo(self):
        """ExÃ©cuter dÃ©monstration complÃ¨te"""
        print("\n" + "="*60)
        print("ğŸš€ DÃ‰MONSTRATION SUPERWHISPER V6 PIPELINE")
        print("ğŸš¨ CODE OBLIGATOIRE DU PROMPT UTILISÃ‰")
        print("="*60)
        
        try:
            await self._show_menu()
        except KeyboardInterrupt:
            print("\nğŸ›‘ DÃ©monstration interrompue par l'utilisateur")
        except Exception as e:
            LOGGER.error(f"âŒ Erreur dÃ©monstration: {e}")
            print(f"âŒ Erreur: {e}")
    
    async def _show_menu(self):
        """Menu principal dÃ©monstration"""
        while True:
            print("\nğŸ¯ OPTIONS DÃ‰MONSTRATION")
            print("-" * 40)
            print("1. ğŸš€ DÃ©marrer pipeline complet (code obligatoire)")
            print("2. ğŸ§ª Test validation environnement")
            print("3. ğŸ“Š Afficher configuration")
            print("4. ğŸ‘‹ Quitter")
            
            try:
                choice = input("\nğŸ‘‰ Votre choix (1-4): ").strip()
                
                if choice == "1":
                    await self._start_pipeline_obligatoire()
                elif choice == "2":
                    await self._test_environment()
                elif choice == "3":
                    self._show_config()
                elif choice == "4":
                    print("ğŸ‘‹ Au revoir!")
                    break
                else:
                    print("âŒ Choix invalide. Utilisez 1-4.")
                    
            except KeyboardInterrupt:
                print("\nğŸ›‘ DÃ©monstration interrompue")
                break
            except Exception as e:
                print(f"âŒ Erreur: {e}")
    
    async def _start_pipeline_obligatoire(self):
        """DÃ©marrer pipeline avec code obligatoire du prompt"""
        print("\nğŸš€ DÃ‰MARRAGE PIPELINE - CODE OBLIGATOIRE")
        print("="*50)
        print("âš ï¸ Assurez-vous que:")
        print("  - Votre microphone est connectÃ©")
        print("  - Le serveur LLM est dÃ©marrÃ© (http://localhost:8000)")
        print("  - Appuyez sur Ctrl+C pour arrÃªter")
        print("\nğŸ¤ Parlez dans votre microphone...")
        
        try:
            # Utiliser la fonction bootstrap OBLIGATOIRE du prompt
            await _bootstrap(self.config_path)
        except KeyboardInterrupt:
            print("\nğŸ›‘ Pipeline arrÃªtÃ©")
        except Exception as e:
            print(f"âŒ Erreur pipeline: {e}")
            LOGGER.error(f"Pipeline error: {e}")
    
    async def _test_environment(self):
        """Test validation environnement"""
        print("\nğŸ§ª TEST VALIDATION ENVIRONNEMENT")
        print("-" * 40)
        
        # Test GPU
        print("ğŸ” Validation GPU RTX 3090...")
        try:
            from PIPELINE.scripts.assert_gpu_env import main as validate_gpu
            validate_gpu()
            print("âœ… GPU RTX 3090 validÃ©e")
        except Exception as e:
            print(f"âŒ Erreur validation GPU: {e}")
        
        # Test audio
        print("ğŸ” Validation devices audio...")
        try:
            from PIPELINE.scripts.validate_audio_devices import main as validate_audio
            validate_audio()
            print("âœ… Devices audio validÃ©s")
        except Exception as e:
            print(f"âš ï¸ Avertissement audio: {e}")
        
        # Test LLM
        print("ğŸ” Test serveur LLM...")
        try:
            from PIPELINE.scripts.start_llm import main as validate_llm
            await validate_llm()
            print("âœ… Serveur LLM accessible")
        except Exception as e:
            print(f"âš ï¸ Avertissement LLM: {e}")
            print("   Le pipeline utilisera les fallbacks")
        
        print("\nâœ… Tests environnement terminÃ©s")
    
    def _show_config(self):
        """Afficher configuration actuelle"""
        print("\nğŸ“Š CONFIGURATION PIPELINE")
        print("-" * 30)
        
        try:
            import yaml
            if Path(self.config_path).exists():
                with open(self.config_path, 'r', encoding='utf-8') as f:
                    config = yaml.safe_load(f)
                
                print(f"ğŸ“ Fichier: {self.config_path}")
                print(f"ğŸ¤ STT Backend: {config.get('stt', {}).get('primary_backend', 'N/A')}")
                print(f"ğŸ”Š TTS Backend: {config.get('tts', {}).get('primary_backend', 'N/A')}")
                print(f"ğŸ¤– LLM Endpoint: {config.get('pipeline', {}).get('llm_endpoint', 'N/A')}")
                print(f"ğŸ“Š MÃ©triques: {config.get('pipeline', {}).get('enable_metrics', False)}")
                print(f"ğŸ® GPU: RTX 3090 (CUDA:1) - OBLIGATOIRE")
            else:
                print(f"âš ï¸ Configuration non trouvÃ©e: {self.config_path}")
                print("ğŸ“‹ Configuration par dÃ©faut sera utilisÃ©e")
        except Exception as e:
            print(f"âŒ Erreur lecture configuration: {e}")

# =============================================================================
# SCRIPT ENTRY POINT - CODE OBLIGATOIRE DU PROMPT
# =============================================================================

async def main():
    """Point d'entrÃ©e principal - utilise code obligatoire"""
    demo = PipelineDemo()
    await demo.run_demo()

def signal_handler(signum, frame):
    """Gestionnaire signal pour arrÃªt propre"""
    print("\nğŸ›‘ Signal d'arrÃªt reÃ§u...")
    sys.exit(0)

if __name__ == "__main__":
    # Gestionnaire signaux
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    try:
        # Optimisation uvloop comme dans le prompt obligatoire
        try:
            import uvloop
            uvloop.install()
            LOGGER.info("âœ… uvloop enabled for enhanced performance")
        except ImportError:
            LOGGER.info("uvloop not available â€“ fallback to asyncio eventâ€‘loop")

        # DÃ©marrer dÃ©monstration
        asyncio.run(main())
    except KeyboardInterrupt:
        LOGGER.info("ğŸ‘‹ Keyboard interrupt â€“ exit")
    except Exception as e:
        LOGGER.error("âŒ Demo startup error: %s", e)
        sys.exit(1) 