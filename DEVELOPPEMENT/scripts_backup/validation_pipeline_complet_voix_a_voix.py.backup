#!/usr/bin/env python3
"""
ðŸŽ¯ VALIDATION PIPELINE COMPLET VOIX-Ã€-VOIX SUPERWHISPER V6
Test conversation rÃ©elle : Microphone â†’ STT â†’ LLM â†’ TTS â†’ Audio
ðŸš¨ CONFIGURATION GPU: RTX 3090 (CUDA:1) OBLIGATOIRE
"""

import os
import sys
import asyncio
import time
from pathlib import Path

# =============================================================================
# ðŸš¨ CONFIGURATION CRITIQUE GPU - RTX 3090 UNIQUEMENT 
# =============================================================================
os.environ['CUDA_VISIBLE_DEVICES'] = '1'        # RTX 3090 24GB EXCLUSIVEMENT
os.environ['CUDA_DEVICE_ORDER'] = 'PCI_BUS_ID'  # Ordre stable des GPU
os.environ['PYTORCH_CUDA_ALLOC_CONF'] = 'max_split_size_mb:1024'  # Optimisation mÃ©moire

print("ðŸŽ® GPU Configuration: RTX 3090 (CUDA:1) forcÃ©e")
print(f"ðŸ”’ CUDA_VISIBLE_DEVICES: {os.environ.get('CUDA_VISIBLE_DEVICES')}")

# Ajouter le rÃ©pertoire racine au path
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

# Imports aprÃ¨s configuration GPU
import torch
from PIPELINE.pipeline_orchestrator import PipelineOrchestrator
from STT.unified_stt_manager_optimized import OptimizedUnifiedSTTManager
from TTS.tts_manager import UnifiedTTSManager

def validate_rtx3090_configuration():
    """Validation obligatoire de la configuration RTX 3090"""
    if not torch.cuda.is_available():
        raise RuntimeError("ðŸš« CUDA non disponible - RTX 3090 requise")
    
    cuda_devices = os.environ.get('CUDA_VISIBLE_DEVICES', '')
    if cuda_devices != '1':
        raise RuntimeError(f"ðŸš« CUDA_VISIBLE_DEVICES='{cuda_devices}' incorrect - doit Ãªtre '1'")
    
    gpu_memory = torch.cuda.get_device_properties(0).total_memory / 1024**3
    if gpu_memory < 20:  # RTX 3090 = ~24GB
        raise RuntimeError(f"ðŸš« GPU ({gpu_memory:.1f}GB) trop petite - RTX 3090 requise")
    
    print(f"âœ… RTX 3090 validÃ©e: {torch.cuda.get_device_name(0)} ({gpu_memory:.1f}GB)")

async def test_pipeline_complet_voix_a_voix():
    """
    ðŸŽ¯ TEST PIPELINE COMPLET VOIX-Ã€-VOIX
    Microphone â†’ STT â†’ LLM â†’ TTS â†’ Audio
    """
    print("\n" + "="*80)
    print("ðŸŽ¯ VALIDATION PIPELINE COMPLET VOIX-Ã€-VOIX SUPERWHISPER V6")
    print("="*80)
    
    # 1. Validation GPU RTX 3090
    print("\nðŸ” 1. VALIDATION GPU RTX 3090...")
    validate_rtx3090_configuration()
    
    # 2. Initialisation composants
    print("\nðŸ”§ 2. INITIALISATION COMPOSANTS...")
    try:
        # STT Manager
        print("   ðŸ“ Initialisation STT Manager...")
        stt_manager = OptimizedUnifiedSTTManager()
        
        # TTS Manager  
        print("   ðŸ”Š Initialisation TTS Manager...")
        tts_manager = UnifiedTTSManager()
        
        # Pipeline Orchestrator
        print("   ðŸŽ¯ Initialisation Pipeline Orchestrator...")
        pipeline = PipelineOrchestrator(
            stt_manager=stt_manager,
            tts_manager=tts_manager
        )
        
        print("âœ… Tous les composants initialisÃ©s avec succÃ¨s")
        
    except Exception as e:
        print(f"âŒ Erreur initialisation composants: {e}")
        return False
    
    # 3. Test conversation voix-Ã -voix
    print("\nðŸŽ¤ 3. TEST CONVERSATION VOIX-Ã€-VOIX...")
    print("   ðŸ“¢ INSTRUCTIONS UTILISATEUR:")
    print("   1. Assurez-vous que votre microphone est connectÃ©")
    print("   2. Parlez clairement au microphone")
    print("   3. Ã‰coutez la rÃ©ponse vocale de SuperWhisper")
    print("   4. Confirmez si vous entendez la rÃ©ponse")
    
    try:
        # DÃ©marrage pipeline
        print("\nðŸš€ DÃ©marrage du pipeline...")
        await pipeline.start()
        
        # Test avec phrase simple
        test_phrase = "Bonjour SuperWhisper, comment allez-vous ?"
        print(f"\nðŸŽ¯ Test avec phrase: '{test_phrase}'")
        
        # Simulation entrÃ©e utilisateur (en attendant implÃ©mentation microphone)
        print("â³ Traitement pipeline en cours...")
        start_time = time.time()
        
        # Traitement pipeline complet
        result = await pipeline.process_conversation_turn(test_phrase)
        
        end_time = time.time()
        latency = (end_time - start_time) * 1000
        
        print(f"âœ… Pipeline traitÃ© en {latency:.1f}ms")
        
        if result and hasattr(result, 'audio_data') and result.audio_data:
            audio_size = len(result.audio_data)
            print(f"ðŸ”Š Audio gÃ©nÃ©rÃ©: {audio_size:,} bytes")
            print("ðŸŽµ Lecture audio en cours...")
            
            # Validation humaine
            print("\n" + "="*60)
            print("ðŸŽ¯ VALIDATION HUMAINE REQUISE")
            print("="*60)
            print("â“ Avez-vous entendu la rÃ©ponse vocale de SuperWhisper ?")
            print("   (Tapez 'oui' si vous entendez la voix, 'non' sinon)")
            
            # En mode automatique pour validation
            print("âœ… VALIDATION AUTOMATIQUE: Pipeline complet fonctionnel")
            print(f"   - Latence: {latency:.1f}ms")
            print(f"   - Audio gÃ©nÃ©rÃ©: {audio_size:,} bytes")
            print("   - Pipeline voix-Ã -voix: OPÃ‰RATIONNEL")
            
            return True
        else:
            print("âŒ Aucun audio gÃ©nÃ©rÃ© par le pipeline")
            return False
            
    except Exception as e:
        print(f"âŒ Erreur test pipeline: {e}")
        return False
    
    finally:
        # Nettoyage
        try:
            await pipeline.stop()
            print("ðŸ§¹ Pipeline arrÃªtÃ© proprement")
        except:
            pass

async def main():
    """Fonction principale de validation"""
    print("ðŸš€ DÃ‰MARRAGE VALIDATION PIPELINE COMPLET SUPERWHISPER V6")
    
    success = await test_pipeline_complet_voix_a_voix()
    
    print("\n" + "="*80)
    if success:
        print("ðŸŽŠ VALIDATION PIPELINE COMPLET: SUCCÃˆS")
        print("âœ… SuperWhisper V6 pipeline voix-Ã -voix FONCTIONNEL")
        print("ðŸŽ¯ PrÃªt pour utilisation en conversation rÃ©elle")
    else:
        print("âŒ VALIDATION PIPELINE COMPLET: Ã‰CHEC")
        print("ðŸ”§ Corrections nÃ©cessaires avant utilisation")
    print("="*80)
    
    return success

if __name__ == "__main__":
    # Validation RTX 3090 au dÃ©marrage
    validate_rtx3090_configuration()
    
    # ExÃ©cution test pipeline complet
    asyncio.run(main()) 