#!/usr/bin/env python3
"""
Script d'aide rapide pour la documentation obligatoire.
Usage: python luxa/scripts/doc-check.py [--update]
"""

import os
import sys
import subprocess
from datetime import datetime
from pathlib import Path


def get_project_root():
    """Trouve la racine du projet"""
    current = Path.cwd()
    while current != current.parent:
        if (current / '.taskmaster').exists():
            return current
        current = current.parent
    return None


def create_journal_entry():
    """CrÃ©e une nouvelle entrÃ©e de journal avec le template"""
    project_root = get_project_root()
    if not project_root:
        print("âŒ Racine du projet non trouvÃ©e")
        return False
    
    journal_path = project_root / "docs" / "journal_developpement.md"
    today = datetime.now().strftime("%Y-%m-%d")
    
    template = f"""
### {today} - [Titre de la session]
**Contexte**: [Description du problÃ¨me/objectif]

**Analyse**:
- [Point d'analyse 1]
- [Point d'analyse 2]

**DÃ©cisions techniques**:
- [DÃ©cision 1 avec justification]
- [DÃ©cision 2 avec justification]

**ImplÃ©mentation**:
- [x] [TÃ¢che complÃ©tÃ©e]
- [ ] [TÃ¢che en cours]

**Tests/Validation**:
- [RÃ©sultat test 1]
- [RÃ©sultat test 2]

**Notes importantes**:
- [Note critique 1]
- [Note critique 2]

**Prochaines Ã©tapes**:
- [ ] [Action suivante]
- [ ] [Action suivante]

---

"""
    
    try:
        with open(journal_path, 'a', encoding='utf-8') as f:
            f.write(template)
        print(f"âœ… Nouvelle entrÃ©e ajoutÃ©e dans {journal_path}")
        print(f"ğŸ“ Ã‰ditez le fichier pour complÃ©ter la documentation")
        return True
    except Exception as e:
        print(f"âŒ Erreur lors de l'ajout: {e}")
        return False


def show_status():
    """Affiche le statut de la documentation et TaskManager"""
    print("ğŸ“Š STATUS DE LA DOCUMENTATION OBLIGATOIRE")
    print("=" * 50)
    
    # VÃ©rifier le journal
    project_root = get_project_root()
    if project_root:
        journal_path = project_root / "docs" / "journal_developpement.md"
        if journal_path.exists():
            mod_time = datetime.fromtimestamp(journal_path.stat().st_mtime)
            print(f"ğŸ“„ Journal: {journal_path}")
            print(f"ğŸ• DerniÃ¨re modification: {mod_time.strftime('%Y-%m-%d %H:%M:%S')}")
        else:
            print("âŒ Journal non trouvÃ© !")
    
    # VÃ©rifier TaskManager
    try:
        result = subprocess.run(['task-master', 'show', '11'], 
                              capture_output=True, text=True, check=True)
        print("\nğŸ“‹ TÃ‚CHE TASKMASTER #11:")
        # Extraire info importante
        lines = result.stdout.split('\n')
        for line in lines:
            if 'Status:' in line or 'Subtasks' in line or 'Progress:' in line:
                print(f"   {line.strip()}")
    except:
        print("âš ï¸  TaskManager non disponible")
    
    # VÃ©rifier Git
    try:
        result = subprocess.run(['git', 'status', '--porcelain'], 
                              capture_output=True, text=True, check=True)
        if result.stdout.strip():
            print(f"\nğŸ”„ Changements Git non commitÃ©es: {len(result.stdout.strip().split())}")
        else:
            print("\nâœ… Pas de changements Git en attente")
    except:
        print("\nâš ï¸  Git non disponible")


def main():
    """Fonction principale"""
    if len(sys.argv) > 1 and sys.argv[1] == '--update':
        print("ğŸ“ Ajout d'une nouvelle entrÃ©e de journal...")
        if create_journal_entry():
            print("\nğŸ’¡ N'oubliez pas de:")
            print("   1. ComplÃ©ter le template avec vos informations")
            print("   2. Sauvegarder le fichier")
            print("   3. Commiter dans Git")
            print("   4. Marquer les tÃ¢ches TaskManager terminÃ©es")
        else:
            sys.exit(1)
    else:
        show_status()
        print("\nğŸ”§ COMMANDES DISPONIBLES:")
        print("   python luxa/scripts/doc-check.py --update  # Ajouter nouvelle entrÃ©e")
        print("   task-master show 11                        # Voir tÃ¢che documentation")
        print("   task-master set-status --id=11.2 --status=done  # Marquer tÃ¢che Git")


if __name__ == "__main__":
    main() 